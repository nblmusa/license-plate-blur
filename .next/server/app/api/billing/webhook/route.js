"use strict";(()=>{var e={};e.id=9302,e.ids=[9302],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},52864:e=>{e.exports=require("bufferutil")},2239:e=>{e.exports=require("utf-8-validate")},14300:e=>{e.exports=require("buffer")},32081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},41808:e=>{e.exports=require("net")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},24404:e=>{e.exports=require("tls")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},34239:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>g,originalPathname:()=>h,requestAsyncStorage:()=>_,routeModule:()=>b,serverHooks:()=>x,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>f});var o={};r.r(o),r.d(o,{POST:()=>p}),r(95655);var i=r(83323),s=r(54647),a=r(59859),n=r(66886),u=r(17207),c=r(35555);let d=process.env.STRIPE_WEBHOOK_SECRET;async function p(e){try{let t;let r=await e.text(),o=(0,a.headers)().get("Stripe-Signature");if(!o||!d)return n.Z.json({error:"Missing signature or webhook secret"},{status:400});try{t=c.Ag.webhooks.constructEvent(r,o,d)}catch(e){return console.error("Webhook signature verification failed:",e),n.Z.json({error:"Webhook signature verification failed"},{status:400})}let i=(0,u.createRouteHandlerClient)({cookies:a.cookies});switch(t.type){case"customer.subscription.created":case"customer.subscription.updated":{let e=t.data.object,r=e.customer,o=e.status;e.items.data[0].price.id;let s=new Date(1e3*e.current_period_start),a=new Date(1e3*e.current_period_end),{error:u}=await i.from("subscriptions").update({stripe_subscription_id:e.id,status:o,current_period_start:s,current_period_end:a,cancel_at_period_end:e.cancel_at_period_end,updated_at:new Date().toISOString()}).eq("stripe_customer_id",r);if(u)return console.error("Failed to update subscription:",u),n.Z.json({error:"Failed to update subscription"},{status:500});break}case"customer.subscription.deleted":{let e=t.data.object,r=e.customer,{error:o}=await i.from("subscriptions").update({status:"canceled",updated_at:new Date().toISOString()}).eq("stripe_customer_id",r);if(o)return console.error("Failed to cancel subscription:",o),n.Z.json({error:"Failed to cancel subscription"},{status:500});break}case"invoice.paid":{let e=t.data.object;e.customer;let{error:r}=await i.from("invoices").insert([{stripe_invoice_id:e.id,amount_due:e.amount_due,amount_paid:e.amount_paid,status:e.status,invoice_pdf:e.invoice_pdf,created_at:new Date(1e3*e.created).toISOString()}]);if(r)return console.error("Failed to record invoice:",r),n.Z.json({error:"Failed to record invoice"},{status:500});break}case"invoice.payment_failed":{let e=t.data.object,r=e.customer,{error:o}=await i.from("subscriptions").update({status:"past_due",updated_at:new Date().toISOString()}).eq("stripe_customer_id",r);if(o)return console.error("Failed to update subscription status:",o),n.Z.json({error:"Failed to update subscription status"},{status:500});break}default:console.log(`Unhandled event type: ${t.type}`)}return n.Z.json({received:!0})}catch(e){return console.error("Webhook error:",e),n.Z.json({error:"Webhook handler failed"},{status:500})}}let l=i.AppRouteRouteModule,b=new l({definition:{kind:s.x.APP_ROUTE,page:"/api/billing/webhook/route",pathname:"/api/billing/webhook",filename:"route",bundlePath:"app/api/billing/webhook/route"},resolvedPagePath:"/Users/nabilmusa/development/license-plate-masking/app/api/billing/webhook/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:_,staticGenerationAsyncStorage:m,serverHooks:x,headerHooks:g,staticGenerationBailout:f}=b,h="/api/billing/webhook/route"}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[4650,4856,9790,1604,5555],()=>r(34239));module.exports=o})();