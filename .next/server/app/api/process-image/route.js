"use strict";(()=>{var e={};e.id=2744,e.ids=[2744],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},52864:e=>{e.exports=require("bufferutil")},2239:e=>{e.exports=require("utf-8-validate")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},41808:e=>{e.exports=require("net")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},24404:e=>{e.exports=require("tls")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},79143:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>k,originalPathname:()=>z,requestAsyncStorage:()=>v,routeModule:()=>M,serverHooks:()=>q,staticGenerationAsyncStorage:()=>j,staticGenerationBailout:()=>S});var a={};r.r(a),r.d(a,{POST:()=>b,dynamic:()=>h}),r(95655);var o=r(83323),s=r(54647),i=r(66886);let n=require("sharp");var l=r.n(n),u=r(17207),p=r(59859);let c=require("@tensorflow/tfjs-node"),d={maskType:"blur",size:100,position:"center",opacity:1,blur:{radius:30,opacity:1}};async function g(){return await c.loadGraphModel("file://./models/license_plate_model/model.json")}async function f(e,t,r=d,a=!1){try{let a;c.engine().startScope();let o=await l()(e),s=await o.metadata(),{width:i=640,height:n=640,format:u}=s;if(t)try{a=await l()(t).trim().toBuffer()}catch(e){console.error("Error preprocessing logo:",e),a=void 0}let p=i/n,d=640,f=640,h=0,y=0;p>1?(f=Math.round(640/p),y=Math.round((640-f)/2)):(d=Math.round(640*p),h=Math.round((640-d)/2));let w=await o.resize(640,640,{fit:"contain",background:{r:0,g:0,b:0,alpha:1}}).raw().toBuffer(),b=i/d,x=n/f,M=c.tensor3d(new Uint8Array(w),[640,640,3]),v=c.tidy(()=>M.div(255).expandDims(0));c.dispose(M);let j=await g(),q=await j.predict(v);c.dispose(v);let k=q.transpose([0,2,1]);c.dispose(q);let S=c.tidy(()=>{let e=k.slice([0,0,2],[-1,-1,1]),t=k.slice([0,0,3],[-1,-1,1]),r=c.sub(k.slice([0,0,0],[-1,-1,1]),c.div(e,2)),a=c.sub(k.slice([0,0,1],[-1,-1,1]),c.div(t,2));return c.concat([a,r,c.add(a,t),c.add(r,e)],2).squeeze()}),[z,P]=c.tidy(()=>{let e=k.slice([0,0,4],[-1,-1,1]).squeeze().reshape([-1]),t=e.sigmoid(),r=c.where(c.abs(c.sub(t,.5)).greater(.1),t,c.zeros(t.shape)),a=c.zeros([e.shape[0]],"int32");return[r,a]});c.dispose(k);let B=await c.image.nonMaxSuppressionAsync(S,z,500,.3,.1),_=S.gather(B,0).dataSync(),A=z.gather(B,0).dataSync();c.dispose([S,z,P,B]);let F=Array.from(_),U=Array.from(A),D=await Promise.all(U.map(async(t,o)=>{if(t<=.1)return[];let[s,u,p,c]=F.slice(4*o,(o+1)*4);u=Math.round((u-h)*b),c=Math.round((c-h)*b),s=Math.round((s-y)*x),p=Math.round((p-y)*x),u=Math.max(0,Math.min(u,i)),c=Math.max(0,Math.min(c,i)),s=Math.max(0,Math.min(s,n)),p=Math.max(0,Math.min(p,n));let d=c-u,g=p-s;if(a)try{let e=Math.round(d*(r.size||100)/100),t=Math.round(g*(r.size||100)/100),o=await l()(a).resize(e,t,{fit:"contain",background:{r:0,g:0,b:0,alpha:0}}).png().toBuffer(),i=u,n=s;switch(r.position){case"top-right":i=c-e;break;case"bottom-left":n=p-t;break;case"bottom-right":i=c-e,n=p-t;break;default:i=u+Math.round((d-e)/2),n=s+Math.round((g-t)/2)}let f=await l()({create:{width:e,height:t,channels:4,background:{r:255,g:255,b:255,alpha:1}}}).composite([{input:o,blend:"over"}]).png().toBuffer();return[{input:f,top:Math.round(n),left:Math.round(i)}]}catch(e){console.error("Error applying logo:",e)}return await m(u,s,d,g,e,r)})),O=D.flat().filter(e=>e),$=await l()(e).composite(O).toFormat(u||"jpeg").toBuffer(),E=await l()(e).resize(320,240,{fit:"contain"}).jpeg().toBuffer();return{processedImage:$,thumbnail:E,detectedPlates:U.filter(e=>e>.1).length,error:void 0}}catch(t){return console.error("Image processing error:",t),{processedImage:e,thumbnail:e,detectedPlates:0,error:t}}finally{c.engine().endScope()}}async function m(e,t,r,a,o,s){if(r<=0||a<=0)return[];try{let i=s.maskType||"blur",n=s.blur?.opacity??1;if("solid"===i){let o=await l()({create:{width:r,height:a,channels:4,background:{r:0,g:0,b:0,alpha:Math.round(255*n)}}}).png().toBuffer();return[{input:o,blend:"over",top:Math.round(t),left:Math.round(e)}]}let u=s.blur?.radius??30,p=await l()(o).extract({left:e,top:t,width:r,height:a}).blur(u).ensureAlpha(n).png().toBuffer();return[{input:p,blend:"over",top:Math.round(t),left:Math.round(e)}]}catch(e){return console.error("Error creating masked region:",e),[]}}let h="force-dynamic";async function y(e){let t=await l()(e).metadata(),{width:r=800,height:a=600,format:o}=t,s=`
    <svg width="800" height="100">
      <text 
        x="50%" 
        y="50%" 
        font-family="Arial" 
        font-size="48" 
        fill="white" 
        text-anchor="middle" 
        dominant-baseline="middle"
        opacity="0.5"
      >
        Sign up to remove watermark
      </text>
    </svg>
  `,i=await l()(Buffer.from(s)).png().toBuffer();return await l()(e).composite([{input:i,blend:"over",top:Math.floor(a/2-50),left:Math.floor(r/2-400)}]).toFormat(o||"jpeg").toBuffer()}async function w(e,t,r){let{data:a,error:o}=await e.storage.from("processed-images").upload(r,t,{contentType:"image/jpeg",upsert:!0});if(o)throw o;let{data:{publicUrl:s}}=e.storage.from("processed-images").getPublicUrl(r);return s}async function b(e){try{let t,r;let a=(0,u.createRouteHandlerClient)({cookies:p.cookies}),{data:{session:o}}=await a.auth.getSession(),s=!!o,n=null,c=null,d=null,g=e.headers.get("content-type");if(g?.includes("multipart/form-data"))try{let t=await e.formData(),r=Array.from(t.entries());console.log("FormData entries:",r.map(([e,t])=>({key:e,type:t instanceof File?"File":"string",fileDetails:t instanceof File?{name:t.name,type:t.type,size:t.size}:null}))),n=t.get("file"),c=t.get("logo"),d=t.get("logoSettings")}catch(e){return console.error("FormData parsing error:",e),i.Z.json({error:"Failed to parse form data",details:e instanceof Error?e.message:"Unknown error"},{status:400})}else if(!g?.includes("application/json"))return console.error("Unsupported content type:",g),i.Z.json({error:"Unsupported content type",expected:"multipart/form-data or application/json",received:g},{status:400});else try{let t=await e.json();if(t.image){let e=t.image.split(",")[1]||t.image,r=Buffer.from(e,"base64"),a=t.filename||"image.jpg";n=new File([r],a,{type:"image/jpeg"})}if(t.logo){let e=t.logo.split(",")[1]||t.logo;c=new File([Buffer.from(e,"base64")],"logo.png",{type:"image/png"})}t.processingOptions&&(d=JSON.stringify(t.processingOptions))}catch(e){return console.error("JSON parsing error:",e),i.Z.json({error:"Failed to parse JSON body",details:e instanceof Error?e.message:"Unknown error"},{status:400})}if(!n)return console.error("No file found in request"),i.Z.json({error:"No file provided or invalid format",contentType:g,isFormData:g?.includes("multipart/form-data"),isJson:g?.includes("application/json")},{status:400});let m=Buffer.from(await n.arrayBuffer());if(c){let e=await c.arrayBuffer();t=Buffer.from(e)}if(d)try{r=JSON.parse(d)}catch(e){console.error("Error parsing logo settings:",e)}console.log("Starting image processing with buffer size:",m.length);let h=await f(m,t,r,s);console.log("Processing result:",{hasProcessedImage:!!h.processedImage,processedImageSize:h.processedImage?.length,detectedPlates:h.detectedPlates,hasError:!!h.error,error:h.error?.message});let b=h.processedImage;s||(console.log("Adding watermark for non-authenticated user"),b=await y(b)),console.log("Creating thumbnail from processed image");let x=await l()(b).resize(320,240,{fit:"contain",background:{r:0,g:0,b:0,alpha:0}}).toBuffer(),M=null,v=null;if(s&&o){console.log("User is authenticated, uploading to storage");let e=o.user.id,r=Date.now(),s=n.name.replace(/\.[^/.]+$/,"");try{M=await w(a,b,`${e}/${r}_${s}_processed.jpg`),console.log("Processed image uploaded successfully:",M),v=await w(a,x,`${e}/${r}_${s}_thumb.jpg`),console.log("Thumbnail uploaded successfully:",v);let{error:o}=await a.from("processed_images").insert([{user_id:e,filename:n.name,license_plates_detected:h.detectedPlates,processed_url:M,thumbnail_url:v,metadata:{originalSize:m.length,processedSize:b.length,logoApplied:!!t}}]);if(o)throw console.error("Database insert error:",o),o;let{error:i}=await a.rpc("update_user_stats",{p_user_id:e,p_plates_detected:h.detectedPlates});if(i)throw console.error("Stats update error:",i),i}catch(e){throw console.error("Upload/database error:",e),e}}console.log("Converting processed image to base64, size:",b.length);let j=n.type||"image/jpeg",q=`data:${j};base64,${b.toString("base64")}`;return i.Z.json({success:!0,maskedImage:q,metadata:{licensePlatesDetected:h.detectedPlates,originalSize:m.length,processedSize:b.length,logoApplied:!!t,contentType:j},processedImageUrl:M,thumbnailUrl:v})}catch(e){return console.error("Processing error:",e),i.Z.json({error:"Failed to process image"},{status:500})}}let x=o.AppRouteRouteModule,M=new x({definition:{kind:s.x.APP_ROUTE,page:"/api/process-image/route",pathname:"/api/process-image",filename:"route",bundlePath:"app/api/process-image/route"},resolvedPagePath:"/Users/nabilmusa/development/license-plate-masking/app/api/process-image/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:v,staticGenerationAsyncStorage:j,serverHooks:q,headerHooks:k,staticGenerationBailout:S}=M,z="/api/process-image/route"}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[4650,4856,9790],()=>r(79143));module.exports=a})();